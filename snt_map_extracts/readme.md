# SNT Malaria Atlas Project (MAP) Extracts Pipeline

This pipeline is designed to extract raster data from the Malaria Atlas Project (MAP). It computes zonal statistics, including population-weighted metrics.

## Parameters
*   **`pop_raster_selection`** (File, optional):
    *   **Name:** Population raster selection (.tif)
    *   **Description:** Select the population raster (.tif) file to be used for population-weighted calculations. Population rasters can be manually downloaded from: [WorldPop population dataset](https://hub.worldpop.org/geodata/listing?id=135)
    *   **Default:** `None`

*   **`target_year`** (String, required):
    *   **Name:** Target Year
    *   **Description:** Specifies the target year for indicator selection (e.g., "2022"). If the specified year is unavailable or not provided, the pipeline will default to the latest available data.
    *   **Default:** `None`

## Functionality Overview
The pipeline performs the following key operations:

1.  **Shape Loading:** Retrieves geographical shapes from the specified dataset, filtering out invalid geometries.
2.  **Raster Retrieval:** Connects to the Malaria Atlas Project (MAP) to download raster data for specified indicators and target year, based on the `snt_indicators` defined in the pipeline.
3.  **Zonal Statistics Calculation:** Computes zonal statistics for each downloaded raster layer against the provided geographical shapes.
4.  **Population-Weighted Metric Calculation (Optional):** If a population raster is provided, it calculates population-weighted metrics for the indicators. 

## Inputs
The pipeline requires the following inputs:
*   **Geographical Shapes:** A GeoJSON file named `[COUNTRY_CODE]_shapes.geojson` obtained from the `DHIS2_DATASET_FORMATTED` dataset. This file is generated by the `DHIS2 Formatting` pipeline and its prerequisite for zonal statistics.
*   **Population Raster (Optional):** A `.tif` file specified via the `pop_raster_selection` parameter, used for population-weighted calculations. If not provided, the metric is not computed.

## Outputs
*   **`[COUNTRY_CODE]_map_data.parquet` and `[COUNTRY_CODE]_map_data.csv`**: These files contain the aggregated MAP data and computed statistics in a long format table. The statistics included depend on their availability in the downloaded rasters from MAP. Both files are saved to the `SNT_MAP_EXTRACTS` dataset.

    > **Notes for the Data Analyst:**
    > - **`VALUE`**: Stores the values as extracted from MAP.
    > - **`POPULATION_WEIGHTED`**: Stores the population-weighted **values**. This column will be empty if no `.tif` file is provided to `pop_raster_selection`.
    > - **`STATISTIC`**: Indicates the type of summary statistic. The pipeline produces "MEAN", "UCI" (upper confidence interval), and "LCI" (lower confidence interval) summaries.
    > - **`VERSION`**: Stores the version of the data downloaded from MAP (e.g., "202508").
*   **Log Files:** Detailed log files are generated within the `pipelines/snt_map_extracts/logs` directory, providing insights into the pipeline's execution.

### Supported Indicators
The pipeline is currently configured to extract the following indicators from the Malaria Atlas Project:

* ü¶ü Malaria Epidemiology:
    * **Pf_Parasite_Rate:** *Plasmodium falciparum* parasite rate (prevalence).
    * **Pf_Mortality_Rate:** Estimated mortality rate due to *P. falciparum*.
    * **Pf_Incidence_Rate:** Estimated number of new cases.
* üõ°Ô∏è Interventions:
    * **Insecticide_Treated_Net_Access:** Proportion of the population with access to ITNs.
    * **Insecticide_Treated_Net_Use_Rate:** Proportion of the population utilizing ITNs.
    * **IRS_Coverage:** Indoor Residual Spraying coverage.
    * **Antimalarial_Effective_Treatment:** Access to effective antimalarial treatment.




