# SNT Map Extracts Pipeline

This pipeline is designed to extract raster data from the Malaria Atlas Project (MAP). It computes zonal statistics, including population-weighted metrics, and generates both CSV and Parquet output files. Additionally, it supports the execution of a reporting notebook for further analysis and visualization.

## Pipeline Parameters

The `snt_map_extracts` pipeline accepts the following parameters:

*   **`pop_raster_selection`** (File, optional):
    *   **Name:** Population raster selection (.tif)
    *   **Description:** Select the population raster (.tif) file to be used for population-weighted calculations.
    *   **Default:** `None`

*   **`target_year`** (String, required):
    *   **Name:** Target Year
    *   **Description:** Specifies the target year for indicator selection (e.g., "2022"). If the specified year is unavailable or not provided, the pipeline will default to the latest available data.
    *   **Default:** `None`

*   **`run_report_only`** (Boolean, optional):
    *   **Name:** Run reporting only
    *   **Description:** If set to `True`, the pipeline will skip the data extraction and calculation steps and only execute the reporting notebook.
    *   **Default:** `False`

*   **`pull_scripts`** (Boolean, optional):
    *   **Name:** Pull Scripts
    *   **Description:** If set to `True`, the pipeline will pull the latest scripts from the associated repository before execution.
    *   **Default:** `False`

## Inputs

The pipeline requires the following inputs:

*   **Configuration File:** `SNT_config.json` located in the `configuration/` directory. This file contains essential settings, including `COUNTRY_CODE` and dataset identifiers.
*   **Geographical Shapes:** A GeoJSON file named `[COUNTRY_CODE]_shapes.geojson` obtained from the `DHIS2_DATASET_FORMATTED` dataset. This file is generated by the `DHIS2 Formatting` pipeline and its prerequisite for zonal statistics.
*   **Population Raster (Optional):** A `.tif` file specified via the `pop_raster_selection` parameter, used for population-weighted calculations. If not provided, the metric is not computed.

## Outputs

The pipeline generates the following output files:

*   **`[COUNTRY_CODE]_map_data.parquet`**: A Parquet file containing the aggregated map data and computed statistics in a long format table. The statistics included depend on their availability in the downloaded rasters from MAP (saved to `SNT_MAP_EXTRACTS` dataset).
*   **`[COUNTRY_CODE]_map_data.csv`**: A CSV file with the same aggregated map data and statistics in a long format table, suitable for easy viewing and integration. The statistics included depend on their availability in the downloaded rasters from MAP (saved to `SNT_MAP_EXTRACTS` dataset).
*   **Log Files:** Detailed log files are generated within the `pipelines/snt_map_extracts/logs` directory, providing insights into the pipeline's execution.
*   **Reporting Notebook Outputs:** Any outputs generated by the `snt_map_extract_report.ipynb` notebook will be stored in `pipelines/snt_map_extracts/reporting/outputs`.

## Functionality Overview

The pipeline performs the following key operations:

1.  **Script Synchronization:** Optionally pulls the latest scripts from the repository.
2.  **Configuration Loading & Validation:** Loads `SNT_config.json` and validates its content.
3.  **Shape Loading:** Retrieves geographical shapes from the specified dataset, filtering out invalid geometries.
4.  **Raster Retrieval:** Connects to the Malaria Atlas Project (MAP) to download raster data for specified indicators and target year, based on the `snt_indicators` defined in the pipeline.
5.  **Zonal Statistics Calculation:** Computes zonal statistics for each downloaded raster layer against the provided geographical shapes.
6.  **Population-Weighted Metric Calculation (Optional):** If a population raster is provided, it calculates population-weighted metrics for the indicators.
7.  **Data Formatting & Saving:** Formats the results into a consistent structure and saves them as Parquet and CSV files.
8.  **Reporting:** Executes a Jupyter notebook for reporting and visualization of the extracted data.

## Error Handling

The pipeline includes logging for various stages and handles exceptions during raster downloading and processing, providing informative messages in case of failures.
